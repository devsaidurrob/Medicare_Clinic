@{
    ViewData["Title"] = "Doctor Management";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Doctor Management</h2>
        <button class="btn btn-primary" type="button" onclick="showCreateDoctorModal()">
            <i class="bi bi-plus-circle"></i> Add New Doctor
        </button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="searchDoctor" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchDoctor" placeholder="Name, specialty...">
            </div>
            <div class="col-md-3">
                <label for="specialtyFilter" class="form-label">Specialty</label>
                <select class="form-select" id="specialtyFilter">
                    <option value="">All Specialties</option>
                    <option>Cardiology</option>
                    <option>Neurology</option>
                    <option>Pediatrics</option>
                    <option>Orthopedics</option>
                    <option>Dermatology</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option>Available</option>
                    <option>On Leave</option>
                    <option>Unavailable</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary me-2">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
                <button class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Sorting Controls -->
    @* <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="sort-controls">
            <span class="me-2">Sort by:</span>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active">Name (A-Z)</button>
                <button type="button" class="btn btn-outline-secondary">Recently Added</button>
                <button type="button" class="btn btn-outline-secondary">Consultation Fee</button>
            </div>
        </div>
        <div class="pagination-info"></div>
    </div> *@

    <!-- Doctors Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="doctorTable">
                    <thead>
                        <tr>
                            <th class="sortable asc" data-FullName>Name</th>
                            <th class="sortable" data-phone>Phone</th>
                            <th class="sortable" data-address>Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="Doctor pagination">
                <ul class="pagination justify-content-end mt-4"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- Create Doctor Modal -->
<div class="modal fade" id="createDoctorModal" tabindex="-1" aria-labelledby="createDoctorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title" id="createDoctorModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add New Doctor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="doctorForm">
                    <!-- Personal Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Personal Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="FirstName" class="form-label required">First Name</label>
                                    <input class="form-control" id="FirstName" name="FirstName" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="LastName" class="form-label required">Last Name</label>
                                    <input class="form-control" id="LastName" name="LastName" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="Email" class="form-label required">Email</label>
                                    <input class="form-control" id="Email" name="Email" type="email" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="Phone" class="form-label required">Phone Number</label>
                                    <input class="form-control" id="Phone" name="Phone" type="tel" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="Gender" class="form-label required">Gender</label>
                                    <select class="form-select" id="Gender" name="Gender" required>
                                        <option value="">Select Gender</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="DateOfBirth" class="form-label">Date of Birth</label>
                                    <input class="form-control" id="DateOfBirth" name="DateOfBirth" type="date" />
                                </div>
                                <div class="col-12">
                                    <label for="Address" class="form-label">Address</label>
                                    <textarea class="form-control" id="Address" name="Address" rows="2"></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="Photo" class="form-label">Profile Photo</label>
                                    <input class="form-control" type="file" id="Photo" name="Photo" accept="image/*" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Professional Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label required">Registration Number</label>
                                    <input class="form-control" id="RegistrationNumber" name="RegistrationNumber" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="SpesializationId" class="form-label required">Specialization</label>
                                    <select class="form-select" id="SpesializationId" name="SpesializationId" multiple="multiple" required></select>
                                </div>
                                <div class="col-md-6">
                                    <label for="DepartmentId" class="form-label">Department</label>
                                    <select class="form-select" id="DepartmentId" name="DepartmentId" multiple="multiple"></select>
                                </div>
                                <div class="col-md-6">
                                    <label for="CreatedAt" class="form-label">Created At</label>
                                    <input class="form-control" id="CreatedAt" name="CreatedAt" readonly />
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveDoctorBtn">
                    <i class="bi bi-save me-1"></i> Save Doctor
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(function () {
            $('#doctorTable').customedatatable('@Url.Action("GetDoctors", "Doctor")', {}, {
                length: 5,
                sortableColumns: ['Name', 'Experience'],
                rowActionBuilder: function (row) {
                    return `<td>
                        <button class="btn btn-sm btn-outline-primary me-1"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-outline-secondary me-1"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </td>`;
                }
            }, '#searchDoctor');
        });

        const createDoctorModal = new bootstrap.Modal(document.getElementById('createDoctorModal'));

        function showCreateDoctorModal() {
            const now = new Date();
            document.getElementById('CreatedAt').value = now.toISOString().slice(0, 16);

            createDoctorModal.show();

             $('#SpesializationId').loadDropdownData(
                '@Url.Action("DoctorSpecialization", "Dropdown")'
                ).done(function () {
                $('#SpesializationId')
                    .attr('multiple', 'multiple')       // ensure multi-select
                    .select2({
                        placeholder: "Select Specializations",
                        width: '100%',
                        dropdownParent: $('#createDoctorModal')
                });
            });

            // Load Departments (multi-select)
            $('#DepartmentId').loadDropdownData(
                '@Url.Action("Department", "Dropdown")'
                ).done(function () {
                $('#DepartmentId')
                    .attr('multiple', 'multiple')       // ensure multi-select
                    .select2({
                        placeholder: "Select Departments",
                        width: '100%',
                        dropdownParent: $('#createDoctorModal')
                 });
            });

            // $('#SpesializationId')
            // .loadDropdownData('@Url.Action("DoctorSpecialization", "Dropdown")', {}, 'SpecializationId', 'Name')
            // .select2({ placeholder: "Select Specializations", width: '100%' });

            // $('#DepartmentId')
            // .loadDropdownData('@Url.Action("Department", "Dropdown")', {}, 'DepartmentId', 'Name')
            // .select2({ placeholder: "Select Departments", width: '100%' });
        }

        document.getElementById('saveDoctorBtn').addEventListener('click', async function () {
            const form = document.getElementById('doctorForm');
            if (form.checkValidity()) {
                const selectedDepartments = $('#DepartmentId').select2('data').map(d => ({
                    Id: parseInt(d.id)
                }));

                const selectedSpecializations = $('#SpesializationId').select2('data').map(d => ({
                    Id: parseInt(d.id)
                }));

                const doctorData = {
                    FirstName: $('#FirstName').val(),
                    LastName: $('#LastName').val(),
                    Gender: $('#Gender').val(),
                    DateOfBirth: $('#DateOfBirth').val(),
                    Email: $('#Email').val(),
                    Phone: $('#Phone').val(),
                    Address: $('#Address').val(),
                    RegistrationNumber: $('#RegistrationNumber').val(),
                    Departments: selectedDepartments,  // array
                    Specializations: selectedSpecializations, // array
                    CreatedAt: new Date($('#CreatedAt').val()).toISOString(),
                    FullName: `${$('#FirstName').val()} ${$('#LastName').val()}`,
                    Photo: $('#Photo')[0].files.length > 0 ? $('#Photo')[0].files[0].name : null
                };
                console.log(doctorData);
                debugger;
                $(this).prop('disabled', true);
                postData('@Url.Action("AddDoctor", "Doctor")', doctorData, {
                    success: function (response) {
                        if (response.success) {
                            createDoctorModal.hide();
                            $('#doctorTable').data('refresh')();
                        }
                    }
                });
                $(this).removeAttr('disabled');
            } else {
                form.classList.add('was-validated');
            }
        });
    </script>
}
